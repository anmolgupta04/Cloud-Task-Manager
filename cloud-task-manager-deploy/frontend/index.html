<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cloud Task Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #070d14; --surface: #0d1825; --surface2: #111f30; --border: rgba(0,180,255,0.12);
  --accent: #00b4ff; --accent2: #00ffb3; --danger: #ff4d6d; --warn: #ffaa00;
  --text: #e8f4ff; --muted: #5a7a99;
}
body { background: var(--bg); color: var(--text); font-family: 'JetBrains Mono', monospace; min-height: 100vh; }
body::before { content:''; position:fixed; inset:0; background-image: linear-gradient(rgba(0,180,255,0.03) 1px,transparent 1px), linear-gradient(90deg,rgba(0,180,255,0.03) 1px,transparent 1px); background-size:40px 40px; pointer-events:none; z-index:0; }

.container { max-width: 1200px; margin: 0 auto; padding: 2rem; position: relative; z-index: 1; }

h1 { font-family: 'Syne', sans-serif; font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; background: linear-gradient(90deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.subtitle { color: var(--muted); font-size: 0.8rem; margin-bottom: 2rem; }

.auth-box { max-width: 400px; margin: 6rem auto; background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 2rem; }
.field { margin-bottom: 1rem; }
.field label { display: block; font-size: 0.7rem; color: var(--muted); margin-bottom: 0.4rem; text-transform: uppercase; }
.field input { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 0.6rem; font-family: inherit; font-size: 0.85rem; color: var(--text); outline: none; }
.field input:focus { border-color: var(--accent); }

.btn { padding: 0.7rem 1.5rem; background: var(--accent); color: var(--bg); border: none; border-radius: 4px; font-family: inherit; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.btn:hover { box-shadow: 0 4px 20px rgba(0,180,255,0.3); }
.btn.secondary { background: transparent; border: 1px solid var(--border); color: var(--muted); }

.stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; }
.stat { background: var(--surface); border: 1px solid var(--border); border-radius: 5px; padding: 1.2rem; }
.stat-val { font-family: 'Syne', sans-serif; font-size: 2rem; font-weight: 700; color: var(--accent); }
.stat-label { font-size: 0.65rem; color: var(--muted); margin-top: 0.3rem; text-transform: uppercase; }

.task-list { display: flex; flex-direction: column; gap: 0.6rem; }
.task { background: var(--surface); border: 1px solid var(--border); border-radius: 5px; padding: 1rem; display: grid; grid-template-columns: auto 1fr auto; gap: 1rem; align-items: center; }
.task:hover { border-color: rgba(0,180,255,0.3); background: var(--surface2); }
.checkbox { width: 20px; height: 20px; border: 1.5px solid var(--border); border-radius: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; }
.checkbox.checked { background: var(--accent2); border-color: var(--accent2); color: var(--bg); }
.task-title { font-size: 0.85rem; color: var(--text); }
.task-title.done { text-decoration: line-through; color: var(--muted); }
.badge { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 2px; font-size: 0.6rem; margin-left: 0.5rem; text-transform: uppercase; }
.badge.todo { background: rgba(90,122,153,0.2); color: var(--muted); }
.badge.in_progress { background: rgba(0,180,255,0.15); color: var(--accent); }
.badge.done { background: rgba(0,255,179,0.12); color: var(--accent2); }
.badge.low { background: rgba(90,122,153,0.15); color: var(--muted); }
.badge.medium { background: rgba(255,170,0,0.15); color: var(--warn); }
.badge.high { background: rgba(255,77,109,0.12); color: var(--danger); }
.badge.critical { background: rgba(255,77,109,0.2); color: var(--danger); }

.btn-icon { padding: 0.4rem 0.6rem; background: transparent; border: 1px solid var(--border); border-radius: 3px; color: var(--muted); font-size: 0.8rem; cursor: pointer; transition: all 0.15s; }
.btn-icon:hover { border-color: var(--accent); color: var(--accent); }
.btn-icon.delete:hover { border-color: var(--danger); color: var(--danger); }

.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100; }
.modal-content { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 2rem; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
.modal-title { font-family: 'Syne', sans-serif; font-size: 1.2rem; font-weight: 700; margin-bottom: 1.5rem; }

.hidden { display: none !important; }
.error { color: var(--danger); font-size: 0.75rem; margin-top: 0.5rem; }
.success { color: var(--accent2); font-size: 0.75rem; margin-top: 0.5rem; }

.toast { position: fixed; bottom: 2rem; right: 2rem; background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; padding: 0.8rem 1.2rem; font-size: 0.75rem; z-index: 200; }
.toast.success { border-color: var(--accent2); color: var(--accent2); }
.toast.error { border-color: var(--danger); color: var(--danger); }

.topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
.user-info { font-size: 0.75rem; color: var(--muted); }
.user-info strong { color: var(--text); }

textarea { resize: vertical; min-height: 80px; }
select { cursor: pointer; }

@media (max-width: 768px) {
  .stats { grid-template-columns: repeat(2, 1fr); }
  .task { grid-template-columns: auto 1fr; }
}
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth" class="auth-box">
  <h1 style="font-size:1.8rem;margin-bottom:0.3rem">☁ CloudTask</h1>
  <div class="subtitle">Production Task Manager</div>
  
  <div class="field">
    <label>Email</label>
    <input type="email" id="email" value="demo@cloudtask.io" />
  </div>
  <div class="field">
    <label>Password</label>
    <input type="password" id="password" value="Demo1234!" />
  </div>
  <button class="btn" onclick="login()">Sign In →</button>
  <div id="auth-error" class="error"></div>
</div>

<!-- APP -->
<div id="app" class="container hidden">
  <div class="topbar">
    <div>
      <h1>My Tasks</h1>
      <div class="user-info">Logged in as <strong id="user-name"></strong> (<span id="user-email"></span>)</div>
    </div>
    <div style="display:flex;gap:1rem">
      <button class="btn" onclick="openModal()">+ New Task</button>
      <button class="btn secondary" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="stats">
    <div class="stat"><div class="stat-val" id="stat-total">0</div><div class="stat-label">Total</div></div>
    <div class="stat"><div class="stat-val" id="stat-done">0</div><div class="stat-label">Done</div></div>
    <div class="stat"><div class="stat-val" id="stat-progress">0</div><div class="stat-label">In Progress</div></div>
    <div class="stat"><div class="stat-val" id="stat-critical">0</div><div class="stat-label">Critical</div></div>
  </div>

  <div class="task-list" id="task-list"></div>
</div>

<!-- MODAL -->
<div id="modal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-title" id="modal-title">New Task</div>
    <input type="hidden" id="task-id" />
    
    <div class="field">
      <label>Title</label>
      <input type="text" id="task-title" />
    </div>
    
    <div class="field">
      <label>Description</label>
      <textarea id="task-desc"></textarea>
    </div>
    
    <div class="field">
      <label>Priority</label>
      <select id="task-priority">
        <option value="low">Low</option>
        <option value="medium" selected>Medium</option>
        <option value="high">High</option>
        <option value="critical">Critical</option>
      </select>
    </div>
    
    <div class="field">
      <label>Status</label>
      <select id="task-status">
        <option value="todo" selected>To Do</option>
        <option value="in_progress">In Progress</option>
        <option value="done">Done</option>
      </select>
    </div>
    
    <div style="display:flex;gap:1rem;margin-top:1.5rem">
      <button class="btn secondary" onclick="closeModal()">Cancel</button>
      <button class="btn" onclick="saveTask()">Save</button>
    </div>
  </div>
</div>

<div id="toast" class="toast hidden"></div>

<script>
const API_URL = '/api/v1';  // Proxied through NGINX
let token = localStorage.getItem('token');
let currentUser = null;
let tasks = [];

async function api(method, path, body) {
  const opts = {
    method,
    headers: {
      'Content-Type': 'application/json',
      ...(token && { 'Authorization': `Bearer ${token}` })
    }
  };
  if (body) opts.body = JSON.stringify(body);
  
  const res = await fetch(API_URL + path, opts);
  if (res.status === 401) { logout(); throw new Error('Unauthorized'); }
  if (res.status === 204) return;
  const data = await res.json();
  if (!res.ok) throw new Error(data.detail || 'API Error');
  return data;
}

async function login() {
  try {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const data = await api('POST', '/auth/login', { email, password });
    token = data.access_token;
    localStorage.setItem('token', token);
    currentUser = await api('GET', '/users/me');
    showApp();
  } catch(e) {
    document.getElementById('auth-error').textContent = e.message;
  }
}

function logout() {
  token = null;
  currentUser = null;
  localStorage.removeItem('token');
  document.getElementById('auth').classList.remove('hidden');
  document.getElementById('app').classList.add('hidden');
}

async function showApp() {
  document.getElementById('auth').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  document.getElementById('user-name').textContent = currentUser.username;
  document.getElementById('user-email').textContent = currentUser.email;
  await loadTasks();
  toast('Welcome back!', 'success');
}

async function loadTasks() {
  try {
    const data = await api('GET', '/tasks/?page_size=100');
    tasks = data.items || [];
    updateStats();
    renderTasks();
  } catch(e) {
    toast('Failed to load tasks', 'error');
  }
}

function updateStats() {
  document.getElementById('stat-total').textContent = tasks.length;
  document.getElementById('stat-done').textContent = tasks.filter(t => t.is_completed).length;
  document.getElementById('stat-progress').textContent = tasks.filter(t => t.status === 'in_progress').length;
  document.getElementById('stat-critical').textContent = tasks.filter(t => t.priority === 'critical' && !t.is_completed).length;
}

function renderTasks() {
  const list = document.getElementById('task-list');
  if (!tasks.length) {
    list.innerHTML = '<div style="text-align:center;padding:3rem;color:var(--muted)">No tasks yet. Create one to get started!</div>';
    return;
  }
  
  list.innerHTML = tasks.map(t => `
    <div class="task">
      <div class="checkbox ${t.is_completed?'checked':''}" onclick="toggleTask(${t.id})">
        ${t.is_completed?'✓':''}
      </div>
      <div>
        <div class="task-title ${t.is_completed?'done':''}">${esc(t.title)}</div>
        <span class="badge ${t.status}">${t.status.replace('_',' ')}</span>
        <span class="badge ${t.priority}">${t.priority}</span>
        ${t.description?`<div style="font-size:0.7rem;color:var(--muted);margin-top:0.3rem">${esc(t.description)}</div>`:''}
      </div>
      <div style="display:flex;gap:0.5rem">
        <button class="btn-icon" onclick="editTask(${t.id})">✎</button>
        <button class="btn-icon delete" onclick="deleteTask(${t.id})">✕</button>
      </div>
    </div>
  `).join('');
}

async function toggleTask(id) {
  const task = tasks.find(t => t.id === id);
  try {
    await api('PATCH', `/tasks/${id}`, { is_completed: !task.is_completed });
    await loadTasks();
    toast('Task updated', 'success');
  } catch(e) {
    toast('Update failed', 'error');
  }
}

async function deleteTask(id) {
  if (!confirm('Delete this task?')) return;
  try {
    await api('DELETE', `/tasks/${id}`);
    await loadTasks();
    toast('Task deleted', 'success');
  } catch(e) {
    toast('Delete failed', 'error');
  }
}

function openModal(task) {
  document.getElementById('modal-title').textContent = task ? 'Edit Task' : 'New Task';
  document.getElementById('task-id').value = task ? task.id : '';
  document.getElementById('task-title').value = task ? task.title : '';
  document.getElementById('task-desc').value = task ? (task.description || '') : '';
  document.getElementById('task-priority').value = task ? task.priority : 'medium';
  document.getElementById('task-status').value = task ? task.status : 'todo';
  document.getElementById('modal').classList.remove('hidden');
}

function editTask(id) {
  const task = tasks.find(t => t.id === id);
  openModal(task);
}

function closeModal() {
  document.getElementById('modal').classList.add('hidden');
}

async function saveTask() {
  const id = document.getElementById('task-id').value;
  const body = {
    title: document.getElementById('task-title').value.trim(),
    description: document.getElementById('task-desc').value.trim() || null,
    priority: document.getElementById('task-priority').value,
    status: document.getElementById('task-status').value,
  };
  
  if (!body.title) { toast('Title required', 'error'); return; }
  
  try {
    if (id) {
      await api('PATCH', `/tasks/${id}`, body);
      toast('Task updated', 'success');
    } else {
      await api('POST', '/tasks/', body);
      toast('Task created', 'success');
    }
    closeModal();
    await loadTasks();
  } catch(e) {
    toast('Save failed', 'error');
  }
}

function toast(msg, type='success') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `toast ${type}`;
  setTimeout(() => el.classList.add('hidden'), 2500);
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// Auto-login if token exists
if (token) {
  api('GET', '/users/me')
    .then(u => { currentUser = u; showApp(); })
    .catch(() => logout());
}

// Close modal on backdrop click
document.getElementById('modal').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeModal();
});
</script>

</body>
</html>
